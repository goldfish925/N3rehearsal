<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ナンバーズ3移動数比較ツール</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background: linear-gradient(135deg, #d4b5a0 0%, #c9a88a 100%);
        }
        .container {
            background: #f5ede4;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        h1 {
            color: #8b6f47;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        h2 {
            color: #8b6f47;
            font-size: 1.1em;
        }
        .input-section {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #d4b5a0;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            color: #8b6f47;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #d4b5a0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        input[type="text"] {
            width: 100%;
            max-width: 150px;
            padding: 10px;
            border: 2px solid #d4b5a0;
            border-radius: 5px;
            font-size: 18px;
            text-align: center;
        }
        button {
            background: linear-gradient(135deg, #a67c52 0%, #8b6f47 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background: linear-gradient(135deg, #8b6f47 0%, #6d5a3a 100%);
        }
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 15px -15px;
            padding: 0 15px;
        }
        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th {
            background: linear-gradient(135deg, #a67c52 0%, #8b6f47 100%);
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            font-size: 0.75em;
        }
        td {
            padding: 8px 5px;
            text-align: center;
            border-bottom: 1px solid #e8ddd0;
            border-right: 1px dotted #d4b5a0;
            font-size: 0.8em;
        }
        td:nth-child(5), td:nth-child(9) {
            border-right: 3px solid #a67c52;
        }
        td:last-child {
            border-right: none;
        }
        tr:hover {
            background: #faf6f0;
        }
        .trend-up {
            color: #c2553d;
            font-weight: bold;
        }
        .trend-down {
            color: #4a7c8e;
            font-weight: bold;
        }
        .trend-same {
            color: #8b8b8b;
        }
        .digit-header {
            background: #d4b5a0;
            color: #5a4a3a;
            font-weight: bold;
        }
        .example {
            background: #fff9f0;
            padding: 10px;
            border-left: 4px solid #a67c52;
            margin-top: 10px;
            font-size: 12px;
            color: #6d5a3a;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #d4b5a0;
            text-align: center;
        }
        .summary-card h3 {
            color: #8b6f47;
            margin: 0 0 8px 0;
            font-size: 0.8em;
        }
        .summary-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #a67c52;
        }
        .predict-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 3px solid #a67c52;
        }
        .predict-box h3 {
            color: #8b6f47;
            margin-top: 0;
            font-size: 1.1em;
        }
        .digit-predict {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .digit-box {
            background: #faf6f0;
            padding: 12px;
            border-radius: 5px;
            border: 2px solid #d4b5a0;
            text-align: center;
        }
        .digit-box h4 {
            color: #8b6f47;
            margin: 0 0 8px 0;
            font-size: 0.9em;
        }
        .direction {
            font-size: 16px;
            font-weight: bold;
            color: #a67c52;
            margin: 8px 0;
        }
        .stars {
            color: #d4a574;
            font-size: 14px;
        }
        .candidates {
            background: #fff9f0;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-weight: bold;
            color: #6d5a3a;
            font-size: 0.85em;
        }
        .recommend {
            background: linear-gradient(135deg, #d4b5a0 0%, #c9a88a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        .recommend h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
        }
        .recommend-numbers {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .info-box {
            background: #fff9f0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #a67c52;
        }
        .info-box h3 {
            color: #8b6f47;
            margin-top: 0;
            font-size: 1em;
        }
        .pattern-item {
            padding: 8px 0;
            border-bottom: 1px dotted #d4b5a0;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 1.1em;
            }
            .input-section {
                padding: 10px;
            }
            button {
                padding: 10px 15px;
                font-size: 13px;
            }
            .digit-predict {
                grid-template-columns: 1fr;
            }
            .summary {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ナンバーズ3 風車盤移動数比較ツール</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label>データ入力（リハ,本番の形式で1行ずつ）</label>
                <textarea id="dataInput" placeholder="例:&#10;822,229&#10;799,275&#10;021,806"></textarea>
                <div class="example">
                    入力例: 822,229（リハ822、本番229）<br>
                    3桁に満たない場合は先頭に0を付けてください（例: 021）
                </div>
            </div>
            <button onclick="analyzeData()">分析開始</button>
        </div>

        <div id="preRehaInfo" style="display:none;"></div>

        <div id="rehaPredict" style="display:none;" class="input-section">
            <h2 style="color: #8b6f47; margin-top: 0;">次回リハ予測</h2>
            <div class="input-group">
                <label>次回リハを入力（3桁）</label>
                <input type="text" id="nextReha" maxlength="3" placeholder="例: 572" style="width: 150px; padding: 10px; border: 2px solid #d4b5a0; border-radius: 5px; font-size: 18px; text-align: center;">
                <button onclick="predictHonban()" style="margin-left: 10px;">本番を予測</button>
            </div>
        </div>

        <div id="prediction" style="display:none;"></div>

        <div id="results"></div>
    </div>

    <script>
        function getTrend(current, previous) {
            if (previous === null || previous === undefined) return '-';
            if (current.value > previous.value) return '↑';
            if (current.value < previous.value) return '↓';
            return '-';
        }

        const kazaguruma = {
            百: [0,1,2,3,4,5,6,7,8,9],
            十: [0,7,4,1,8,5,2,9,6,3],
            一: [0,9,8,7,6,5,4,3,2,1]
        };

        function getMovementBetween(fromDigit, toDigit, wheelArray) {
            const fromPos = wheelArray.indexOf(fromDigit);
            const toPos = wheelArray.indexOf(toDigit);
            
            if (fromPos === toPos) {
                return { value: 0, direction: '-' };
            }
            
            // 左回り（時計回り）の距離
            let leftMove = toPos - fromPos;
            if (leftMove < 0) leftMove += wheelArray.length;
            
            // 右回り（反時計回り）の距離
            let rightMove = fromPos - toPos;
            if (rightMove < 0) rightMove += wheelArray.length;
            
            // 近い方を選択（最大5まで）
            if (leftMove <= rightMove) {
                return { value: Math.min(leftMove, 5), direction: '左' };
            } else {
                return { value: Math.min(rightMove, 5), direction: '右' };
            }
        }

        function getTrend(current, previous) {
            if (previous === null) return '-';
            if (current.value > previous.value) return '↑';
            if (current.value < previous.value) return '↓';
            return '-';
        }

        function analyzeNumber(numStr) {
            const str = numStr.padStart(3, '0');
            const h = parseInt(str[0]);
            const t = parseInt(str[1]);
            const o = parseInt(str[2]);
            
            return {
                original: numStr,
                百: h,
                十: t,
                一: o
            };
        }

        function analyzeData() {
            const input = document.getElementById('dataInput').value.trim();
            if (!input) {
                alert('データを入力してください');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            const data = [];
            
            for (let line of lines) {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length !== 2) continue;
                
                const reha = analyzeNumber(parts[0]);
                const honban = analyzeNumber(parts[1]);
                data.push({ reha, honban });
            }

            if (data.length === 0) {
                alert('有効なデータがありません');
                return;
            }

            displayResults(data);
        }

        function displayResults(data) {
            let html = '<div class="table-wrapper"><table>';
            html += '<thead><tr>';
            html += '<th rowspan="2">回</th>';
            html += '<th colspan="4" class="digit-header">百の位</th>';
            html += '<th colspan="4" class="digit-header">十の位</th>';
            html += '<th colspan="4" class="digit-header">一の位</th>';
            html += '</tr><tr>';
            
            for (let i = 0; i < 3; i++) {
                html += '<th>リハ数</th><th>リハ移動</th><th>本番数</th><th>本番移動</th>';
            }
            html += '</tr></thead><tbody>';

            let prevReha = null;
            let prevHonban = null;

            data.forEach((row, index) => {
                html += '<tr>';
                html += `<td><strong>${index + 1}</strong></td>`;
                
                // 移動数を計算（前回の数字から今回の数字へ）
                const reha百Move = prevReha ? getMovementBetween(prevReha.百, row.reha.百, kazaguruma.百) : { value: 0, direction: '-' };
                const reha十Move = prevReha ? getMovementBetween(prevReha.十, row.reha.十, kazaguruma.十) : { value: 0, direction: '-' };
                const reha一Move = prevReha ? getMovementBetween(prevReha.一, row.reha.一, kazaguruma.一) : { value: 0, direction: '-' };
                
                const honban百Move = prevHonban ? getMovementBetween(prevHonban.百, row.honban.百, kazaguruma.百) : { value: 0, direction: '-' };
                const honban十Move = prevHonban ? getMovementBetween(prevHonban.十, row.honban.十, kazaguruma.十) : { value: 0, direction: '-' };
                const honban一Move = prevHonban ? getMovementBetween(prevHonban.一, row.honban.一, kazaguruma.一) : { value: 0, direction: '-' };
                
                // 百の位
                html += `<td>${row.reha.百}</td>`;
                html += `<td>${reha百Move.direction}${reha百Move.value}</td>`;
                html += `<td>${row.honban.百}</td>`;
                html += `<td>${honban百Move.direction}${honban百Move.value}</td>`;
                
                // 十の位
                html += `<td>${row.reha.十}</td>`;
                html += `<td>${reha十Move.direction}${reha十Move.value}</td>`;
                html += `<td>${row.honban.十}</td>`;
                html += `<td>${honban十Move.direction}${honban十Move.value}</td>`;
                
                // 一の位
                html += `<td>${row.reha.一}</td>`;
                html += `<td>${reha一Move.direction}${reha一Move.value}</td>`;
                html += `<td>${row.honban.一}</td>`;
                html += `<td>${honban一Move.direction}${honban一Move.value}</td>`;
                
                html += '</tr>';

                prevReha = row.reha;
                prevHonban = row.honban;
            });

            html += '</tbody></table>';
            html += '</div>';

            document.getElementById('results').innerHTML = html;
            
            // リハ前参考情報を表示
            showPreRehaInfo(data);
            
            // リハ予測エリアを表示
            document.getElementById('rehaPredict').style.display = 'block';
        }

        let globalData = [];

        function showPreRehaInfo(data) {
            globalData = data;
            const recent = data.slice(-10);
            
            let html = '<div class="info-box">';
            html += '<h3>参考情報（リハ前）- 直近10回の傾向</h3>';
            
            // 各桁の連続パターンを分析
            const patterns = analyzePatterns(recent);
            
            html += '<div class="pattern-item"><strong>百の位：</strong>' + patterns.百 + '</div>';
            html += '<div class="pattern-item"><strong>十の位：</strong>' + patterns.十 + '</div>';
            html += '<div class="pattern-item"><strong>一の位：</strong>' + patterns.一 + '</div>';
            
            html += '<div style="margin-top: 15px; padding: 10px; background: #faf6f0; border-radius: 5px;">';
            html += '<strong>次の動き予想：</strong><br>';
            html += patterns.prediction;
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('preRehaInfo').innerHTML = html;
            document.getElementById('preRehaInfo').style.display = 'block';
        }

        function analyzePatterns(recent) {
            const getLastMoves = (digit) => {
                const moves = [];
                for (let i = recent.length - 5; i < recent.length; i++) {
                    if (i >= 1) {
                        const from = recent[i-1].honban;
                        const to = recent[i].reha;
                        const move = getMovementBetween(from[digit], to[digit], 
                            digit === '百' ? kazaguruma.百 : digit === '十' ? kazaguruma.十 : kazaguruma.一);
                        moves.push(move);
                    }
                }
                return moves;
            };
            
            const analyzeDirection = (moves) => {
                const left = moves.filter(m => m.direction === '左').length;
                const right = moves.filter(m => m.direction === '右').length;
                const same = moves.filter(m => m.direction === '-').length;
                
                let result = '';
                if (left >= 3) result += `左${left}回`;
                if (right >= 3) result += (result ? '、' : '') + `右${right}回`;
                if (same >= 2) result += (result ? '、' : '') + `停滞${same}回`;
                
                const last2 = moves.slice(-2);
                if (last2.length === 2 && last2[0].direction === last2[1].direction && last2[0].direction !== '-') {
                    result += ` / ${last2[0].direction}連続中`;
                }
                
                return result || '変動的';
            };
            
            const 百moves = getLastMoves('百');
            const 十moves = getLastMoves('十');
            const 一moves = getLastMoves('一');
            
            let prediction = '';
            
            // 百の位予想
            const 百Left = 百moves.filter(m => m.direction === '左').length;
            const 百Right = 百moves.filter(m => m.direction === '右').length;
            if (百Right >= 3) prediction += '百：そろそろ左方向か？<br>';
            else if (百Left >= 3) prediction += '百：そろそろ右方向か？<br>';
            
            // 十の位予想
            const 十Left = 十moves.filter(m => m.direction === '左').length;
            const 十Right = 十moves.filter(m => m.direction === '右').length;
            if (十Left >= 3) prediction += '十：左連続中、反転の可能性<br>';
            else if (十Right >= 3) prediction += '十：右連続中、反転の可能性<br>';
            
            // 一の位予想
            const 一Same = 一moves.filter(m => m.direction === '-').length;
            const 一Left = 一moves.filter(m => m.direction === '左').length;
            if (一Same >= 2) prediction += '一：停滞傾向、動き注意';
            else if (一Left >= 4) prediction += '一：左偏り、停滞or右の可能性';
            
            if (!prediction) prediction = '明確な傾向なし、データ蓄積中';
            
            return {
                百: analyzeDirection(百moves),
                十: analyzeDirection(十moves),
                一: analyzeDirection(一moves),
                prediction: prediction
            };
        }

        function predictHonban() {
            const rehaInput = document.getElementById('nextReha').value.trim();
            if (rehaInput.length !== 3 || !/^\d{3}$/.test(rehaInput)) {
                alert('3桁の数字を入力してください');
                return;
            }
            
            if (globalData.length === 0) {
                alert('先にデータ分析を行ってください');
                return;
            }
            
            const rehaNum = analyzeNumber(rehaInput);
            const lastHonban = globalData[globalData.length - 1].honban;
            
            // 前回本番から今回リハへの移動を計算
            const 百move = getMovementBetween(lastHonban.百, rehaNum.百, kazaguruma.百);
            const 十move = getMovementBetween(lastHonban.十, rehaNum.十, kazaguruma.十);
            const 一move = getMovementBetween(lastHonban.一, rehaNum.一, kazaguruma.一);
            
            // 予測ロジック
            const prediction = generatePrediction(globalData, rehaNum, {百: 百move, 十: 十move, 一: 一move});
            
            displayPrediction(prediction, rehaInput);
        }

        function generatePrediction(data, rehaNum, rehaMoves) {
            const recent = data.slice(-10);
            
            // 各桁の予測
            const predict百 = predictDigit(recent, '百', rehaMoves.百);
            const predict十 = predictDigit(recent, '十', rehaMoves.十);
            const predict一 = predictDigit(recent, '一', rehaMoves.一);
            
            return { 百: predict百, 十: predict十, 一: predict一, reha: rehaNum };
        }

        function predictDigit(recent, digitName, currentMove) {
            const wheel = digitName === '百' ? kazaguruma.百 : digitName === '十' ? kazaguruma.十 : kazaguruma.一;
            
            // 直近のリハ→本番の傾向を分析
            let leftCount = 0, rightCount = 0, sameCount = 0;
            
            for (let i = 1; i < recent.length; i++) {
                const rehaDigit = recent[i].reha[digitName];
                const honbanDigit = recent[i].honban[digitName];
                const move = getMovementBetween(rehaDigit, honbanDigit, wheel);
                
                if (move.direction === '左') leftCount++;
                else if (move.direction === '右') rightCount++;
                else sameCount++;
            }
            
            const total = leftCount + rightCount + sameCount;
            
            // 逆相関チェック
            let direction = '不明';
            let confidence = 3;
            
            if (currentMove.direction === '左') {
                if (rightCount > leftCount) {
                    direction = '右';
                    confidence = 4;
                } else {
                    direction = '左';
                    confidence = 3;
                }
            } else if (currentMove.direction === '右') {
                if (leftCount > rightCount) {
                    direction = '左';
                    confidence = 4;
                } else {
                    direction = '右';
                    confidence = 3;
                }
            } else {
                if (sameCount >= 3) {
                    direction = '停滞';
                    confidence = 4;
                } else if (leftCount > rightCount) {
                    direction = '左';
                    confidence = 3;
                } else {
                    direction = '右';
                    confidence = 3;
                }
            }
            
            // 連続パターンボーナス
            const last3 = recent.slice(-3);
            let consecutiveDir = null;
            let consecutiveCount = 0;
            
            for (let i = 1; i < last3.length; i++) {
                const move = getMovementBetween(last3[i].reha[digitName], last3[i].honban[digitName], wheel);
                if (i === 1) {
                    consecutiveDir = move.direction;
                    consecutiveCount = 1;
                } else if (move.direction === consecutiveDir && move.direction !== '-') {
                    consecutiveCount++;
                }
            }
            
            if (consecutiveCount >= 2 && consecutiveDir !== '-') {
                // 連続しているので逆方向の信頼度アップ
                if (consecutiveDir === '左' && direction === '右') confidence = 5;
                if (consecutiveDir === '右' && direction === '左') confidence = 5;
            }
            
            return { direction, confidence };
        }

        function displayPrediction(prediction, rehaInput) {
            let html = '<div class="predict-box">';
            html += '<h3>本番予測結果</h3>';
            html += `<p style="color: #8b6f47;">入力リハ: <strong style="font-size: 24px;">${rehaInput}</strong></p>`;
            
            html += '<div class="digit-predict">';
            
            ['百', '十', '一'].forEach(digit => {
                const pred = prediction[digit];
                html += '<div class="digit-box">';
                html += `<h4>${digit}の位</h4>`;
                html += `<div class="direction">${pred.direction}方向</div>`;
                html += `<div class="stars">${'★'.repeat(pred.confidence)}${'☆'.repeat(5-pred.confidence)}</div>`;
                html += '</div>';
            });
            
            html += '</div>';
            
            html += '<div class="recommend">';
            html += '<h3>推奨候補（参考）</h3>';
            html += '<p style="margin: 10px 0; font-size: 14px;">上記の予測方向を参考に、風車盤から候補を選択してください</p>';
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('prediction').innerHTML = html;
            document.getElementById('prediction').style.display = 'block';
            
            // 予測結果までスクロール
            document.getElementById('prediction').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
</body>
</html>